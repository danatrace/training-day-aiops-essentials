{"id":"1c226b1c-1e12-4d4f-bea5-c98dbd5a80ea","title":"Initiate Create Training Infrastructure AWS","isDeployed":true,"taskDefaults":{},"lastExecution":null,"description":"","actor":"bc935a57-c7d3-440e-922c-79a22bf7afd6","owner":"bc935a57-c7d3-440e-922c-79a22bf7afd6","ownerType":"USER","isPrivate":true,"triggerType":"Manual","schemaVersion":3,"trigger":{},"modificationInfo":{"createdBy":"bc935a57-c7d3-440e-922c-79a22bf7afd6","createdTime":"2026-01-15T04:09:33.433Z","lastModifiedBy":"bc935a57-c7d3-440e-922c-79a22bf7afd6","lastModifiedTime":"2026-01-15T04:09:33.433Z"},"result":"","type":"STANDARD","input":{"awsregion":"us-east-1","owner_email":"","awsaccountid":"","dtaccountuid":"","DTaccesstoken":"","create_dashboards":true,"dt_oauth_client_id":"","InstallOIDCconnection":true,"dt_oauth_client_secret":"","AWS-EBS-remediate-low-storage":{"install":true,"wf_triggers_active":false,"chaos_wf_aws_instances":true,"install_chaos_workflows":true,"chaos_wf_triggers_active":false},"create_workflow_groups_and_policies":true,"create-s3bucket-remediation-workflows":{"install":true,"wf_triggers_active":true,"install_chaos_workflows":true,"chaos_wf_triggers_active":false},"create_aws_systems_manager_roles_for_ec2":true,"create-dynatrace-oidc-connection-settings":{"install":true,"ObjectId":"","dynatraceawsconnection":"554872066791"},"create-aws-security-group-remediation-workflows":{"install":true,"wf_triggers_active":true,"install_chaos_workflows":true,"chaos_wf_triggers_active":false},"AmazonSSMManagedInstanceCore_instance_profile_ec2":"AmazonSSMManagedInstanceCore","AWS-Ec2-remediate-high-cpu-or-memory-consumption-by-processes":{"install":true,"wf_triggers_active":true,"chaos_wf_aws_instances":true,"install_chaos_workflows":true,"chaos_wf_triggers_active":false}},"hourlyExecutionLimit":1000,"throttle":{"isLimitHit":false,"limitEvents":[]},"workflowLimit":{"isActive":false},"version":1,"unacknowledgedSkippedScheduleAt":null,"tasks":{"create-tagging":{"name":"create-tagging","input":{"script":"// optional import of sdk modules\nimport { execution } from '@dynatrace-sdk/automation-utils';\nimport { settingsObjectsClient } from \"@dynatrace-sdk/client-classic-environment-v2\";\n\nexport default async function ({ executionId }) {\n\n  const { input } = await fetch(`/platform/automation/v1/executions/${executionId}`).then((res) => res.json());\n\n  const data =\n    await settingsObjectsClient.postSettingsObjects({\n      adminAccess: false,\n      body: [\n              {\n                  \"schemaId\": \"builtin:tags.auto-tagging\",\n                  \"scope\": \"environment\",\n                  \"value\": {\n                      \"name\": \"Dynatrace-SSM-Action-Demo_\"+input[\"awsaccountid\"]+\"\",\n                      \"rules\": [\n                          {\n                              \"enabled\": true,\n                              \"valueFormat\": null,\n                              \"valueNormalization\": \"Leave text as-is\",\n                              \"type\": \"ME\",\n                              \"attributeRule\": {\n                                  \"entityType\": \"HOST\",\n                                  \"conditions\": [\n                                      {\n                                          \"key\": \"HOST_NAME\",\n                                          \"operator\": \"CONTAINS\",\n                                          \"stringValue\": \"Dynatrace-SSM-Action-Demo_\"+input[\"awsaccountid\"]+\"\",\n                                          \"caseSensitive\": true\n                                      }\n                                  ],\n                                  \"hostToPGPropagation\": true\n                              }\n                          }\n                      ]\n                  }\n              }\n        ]\n  });\n\n\n\n\n  return data ;\n}"},"retry":{"count":5,"delay":30,"failedLoopIterationsOnly":true},"action":"dynatrace.automations:run-javascript","active":true,"position":{"x":0,"y":2},"conditions":{"states":{"s3_delete_bucket_1":"ANY"}},"description":"Run custom JavaScript code.","predecessors":["s3_delete_bucket_1"]},"s3_delete_bucket_1":{"name":"s3_delete_bucket_1","input":{"Bucket":"dynatraceinstall{{execution().id | replace(\"-\",\"\")}}","region":"{{ input()[\"awsregion\"]}}","schema":"builtin:hyperscaler-authentication.connections.aws","connection":"{% set awsconnection = input()[\"create-dynatrace-oidc-connection-settings\"][\"dynatraceawsconnection\"] %}\n{{ connection('builtin:hyperscaler-authentication.connections.aws', awsconnection) }}"},"action":"dynatrace.aws.connector:s3-delete-bucket","active":true,"position":{"x":0,"y":1},"conditions":{"states":{"remove_objects_from_s3":"OK"}},"description":"Deletes the S3 bucket.","predecessors":["remove_objects_from_s3"]},"wait-till-agent-up":{"name":"wait-till-agent-up","input":{"query":"timeseries { max(dt.host.disk.used.percent), from:now()-5m,  value.A = avg(dt.host.disk.used.percent, scalar: true) }, by: { host.name, dt.source_entity, dt.entity.host, dt.entity.ec2_instance }, filter: { matchesValue(entityAttr(dt.entity.host, \"entity.name\"), \"Dynatrace-SSM-Action-Demo_{{input()[\"awsaccountid\"] }}*\") }\n| fieldsAdd dt.entity.host.name = entityName(dt.entity.host)\n| fieldsAdd dt.entity.ec2_instance.name = entityName(dt.entity.ec2_instance)","failOnEmptyResult":true},"retry":{"count":30,"delay":60,"failedLoopIterationsOnly":true},"action":"dynatrace.automations:execute-dql-query","active":true,"timeout":360000,"position":{"x":0,"y":3},"conditions":{"else":"SKIP","states":{"create-tagging":"OK"}},"description":"Make use of Dynatrace Grail data in your workflow.","waitBefore":300,"predecessors":["create-tagging"]},"wait_till_agent_up":{"name":"wait_till_agent_up","input":{"query":"timeseries { max(dt.host.disk.used.percent), from:now()-5m,  value.A = avg(dt.host.disk.used.percent, scalar: true) }, by: { host.name, dt.source_entity, dt.entity.host, dt.entity.ec2_instance }, filter: { matchesValue(entityAttr(dt.entity.host, \"entity.name\"), \"Dynatrace-SSM-Action-Demo_{{input()[\"awsaccountid\"] }}*\") }\n| fieldsAdd dt.entity.host.name = entityName(dt.entity.host)\n| fieldsAdd dt.entity.ec2_instance.name = entityName(dt.entity.ec2_instance)","failOnEmptyResult":true},"retry":{"count":30,"delay":60,"failedLoopIterationsOnly":true},"action":"dynatrace.automations:execute-dql-query","position":{"x":1,"y":1},"conditions":{"states":{"reboot-test-instances":"OK"}},"description":"Make use of Dynatrace Grail data in your workflow.","waitBefore":120,"predecessors":["reboot-test-instances"]},"reboot-test-instances":{"name":"reboot-test-instances","input":{"workflowId":"1accf50e-0ef6-4ab8-853b-d408983ae1da","workflowInput":"{\n  \"awsregion\": \"{{input()[\"awsregion\"] }}\",\n  \"awsaccountid\": \"{{input()[\"awsaccountid\"] }}\",\n  \"dynatraceawsconnection\": \"{{input()[\"create-dynatrace-oidc-connection-settings\"][\"dynatraceawsconnection\"]}}\"\n}"},"action":"dynatrace.automations:run-workflow","active":true,"position":{"x":0,"y":4},"conditions":{"else":"SKIP","custom":"","states":{"wait-till-agent-up":"ANY"}},"description":"Modularize your workflows, run any existing workflow.","waitBefore":30,"predecessors":["wait-till-agent-up"]},"remove_objects_from_s3":{"name":"remove_objects_from_s3","input":{"Key":"{{ _.item }}","Bucket":"dynatraceinstall{{execution().id | replace(\"-\",\"\")}}","region":"{{ input()[\"awsregion\"]}}","schema":"builtin:hyperscaler-authentication.connections.aws","connection":"{% set awsconnection = input()[\"create-dynatrace-oidc-connection-settings\"][\"dynatraceawsconnection\"] %}\n{{ connection('builtin:hyperscaler-authentication.connections.aws', awsconnection) }}"},"action":"dynatrace.aws.connector:s3-delete-object","active":true,"position":{"x":-1,"y":4},"conditions":{"states":{"create-cf-stack-chaos-testing-instances":"OK"}},"withItems":"item in [\"cloudformation_create_role_for_ssm_execution_ec2.yaml\", \"create_remediation_demo_instances.yaml\", \"create_remediation_demo_instances.yaml\"]","concurrency":1,"description":"Removes an object from a bucket.","predecessors":["create-cf-stack-chaos-testing-instances"]},"s3-create-bucket-to-store-yaml":{"name":"s3-create-bucket-to-store-yaml","input":{"Bucket":"dynatraceinstall{{execution().id | replace(\"-\",\"\")}}","region":"{{ input()[\"awsregion\"]}}","connection":"{% set awsconnection = input()[\"create-dynatrace-oidc-connection-settings\"][\"dynatraceawsconnection\"] %}\n{{ connection('builtin:hyperscaler-authentication.connections.aws', awsconnection) }}"},"retry":{"count":5,"delay":30,"failedLoopIterationsOnly":true},"action":"dynatrace.aws.connector:s3-create-bucket","active":true,"position":{"x":-1,"y":1},"conditions":{"else":"SKIP","states":{}},"description":"This action creates an Amazon S3 bucket.","predecessors":[]},"create-cf-stack-chaos-testing-instances":{"name":"create-cf-stack-chaos-testing-instances","input":{"workflowId":"e85d9c9e-30a9-44db-a429-0b781bad389a","workflowInput":"{\n  \"awsregion\": \"{{ input()[\"awsregion\"]}}\",\n  \"cfyamls3url\": \"https://dynatraceinstall{{execution().id | replace(\"-\",\"\")}}.s3.{{ input()[\"awsregion\"]}}.amazonaws.com/create_remediation_demo_instances.yaml\",\n  \"cf_stackname\": \"dynatrace-chaos-testing-instance-and-ssm-document-{{input()[\"awsaccountid\"] }}\",\n  \"dynatraceawsconnection\": \"{{ input()[\"create-dynatrace-oidc-connection-settings\"][\"dynatraceawsconnection\"]}}\"\n}"},"retry":{"count":5,"delay":30,"failedLoopIterationsOnly":true},"action":"dynatrace.automations:run-workflow","active":true,"position":{"x":-1,"y":3},"conditions":{"else":"SKIP","custom":"","states":{"upload-chaos-testing-instances-yaml-to-s3-bucket":"OK"}},"description":"Modularize your workflows, run any existing workflow.","waitBefore":10,"predecessors":["upload-chaos-testing-instances-yaml-to-s3-bucket"]},"upload-chaos-testing-instances-yaml-to-s3-bucket":{"name":"upload-chaos-testing-instances-yaml-to-s3-bucket","input":{"Key":"create_remediation_demo_instances.yaml","Body":"AWSTemplateFormatVersion: '2010-09-09'\nDescription: Create Chaos Testing Instance for Dynatrace\nParameters:\n\n  DTtenant:\n    Default: {% if \"sprint\" in environment().url %}{{ environment().url | replace(\"apps.\", \"\") }}{% else %}{{ environment().url | replace(\"apps\", \"live\") }}{% endif %}\n    \n    Description: Dynatrace Tenant id without url\n    Type: String\n  DTtoken:\n    Default: {{ input()[\"DTaccesstoken\"] }}\n    Description: Dynatrace Access Token\n    Type: String\n\n\n\nResources:\n\n  InstanceSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      Tags:\n        - Key: environment\n          Value: !Sub \"Dynatrace-SSM-Action-Demo_{{input()[\"awsaccountid\"]}}\"\n      GroupDescription: Default security group\n      \n{% if input()[\"AWS-Ec2-remediate-high-cpu-or-memory-consumption-by-processes\"][\"chaos_wf_aws_instances\"] == true %}\n  EC2Instance:\n    Type: AWS::EC2::Instance\n    Properties:\n      Tags:\n        - Key: Name\n          Value: !Sub \"Dynatrace-SSM-Action-Demo_{{input()[\"awsaccountid\"]}}\"\n        - Key: problem\n          Value: !Sub \"cpu_{{input()[\"awsaccountid\"]}}\"\n      InstanceType: t3.medium\n      IamInstanceProfile: {{ input()[\"AmazonSSMManagedInstanceCore_instance_profile_ec2\"] }}\n      SecurityGroups:\n        - !Ref InstanceSecurityGroup\n      ImageId: ami-04b4f1a9cf54c11d0\n      BlockDeviceMappings:\n        - DeviceName: /dev/sda1\n          Ebs:\n            VolumeSize: 30\n            VolumeType: gp3\n            Encrypted: true\n      UserData:\n        Fn::Base64: !Sub |\n            #!/bin/bash \n            sudo apt update -y \n            sudo apt upgrade -y \n            sudo systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service\n            wget  -O Dynatrace-OneAgent-Linux-1.307.61.20250226-155505.sh \"${ DTtenant }/api/v1/deployment/installer/agent/unix/default/latest?arch=x86\" --header=\"Authorization: Api-Token ${ DTtoken }\"\n            wget https://ca.dynatrace.com/dt-root.cert.pem ; ( echo 'Content-Type: multipart/signed; protocol=\"application/x-pkcs7-signature\"; micalg=\"sha-256\"; boundary=\"--SIGNED-INSTALLER\"'; echo ; echo ; echo '----SIGNED-INSTALLER' ; cat Dynatrace-OneAgent-Linux-1.307.61.20250226-155505.sh ) | openssl cms -verify -CAfile dt-root.cert.pem > /dev/null\n            /bin/sh Dynatrace-OneAgent-Linux-1.307.61.20250226-155505.sh --set-monitoring-mode=fullstack --set-app-log-content-access=true --set-host-name=Dynatrace-SSM-Action-Demo_{{input()[\"awsaccountid\"]}}\n\n\n{% endif %}\n{% if input()[\"AWS-EBS-remediate-low-storage\"][\"chaos_wf_aws_instances\"] == true %}\n\n  EC2Instance2:\n    Type: AWS::EC2::Instance\n    Properties:\n      Tags:\n        - Key: Name\n          Value: !Sub \"Dynatrace-SSM-Action-Demo_{{input()[\"awsaccountid\"]}}\"\n        - Key: problem\n          Value: !Sub \"disk_{{input()[\"awsaccountid\"]}}\"\n      InstanceType: t3.medium\n      IamInstanceProfile: {{ input()[\"AmazonSSMManagedInstanceCore_instance_profile_ec2\"] }}\n      SecurityGroups:\n        - !Ref InstanceSecurityGroup\n      ImageId: ami-04b4f1a9cf54c11d0\n      BlockDeviceMappings:\n        - DeviceName: /dev/sda1\n          Ebs:\n            VolumeSize: 30\n            VolumeType: gp3\n            Encrypted: true\n      UserData:\n        Fn::Base64: !Sub |\n            #!/bin/bash \n            sudo apt update -y \n            sudo apt upgrade -y \n            sudo systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service\n            wget  -O Dynatrace-OneAgent-Linux-1.307.61.20250226-155505.sh \"${ DTtenant }/api/v1/deployment/installer/agent/unix/default/latest?arch=x86\" --header=\"Authorization: Api-Token ${ DTtoken }\"\n            wget https://ca.dynatrace.com/dt-root.cert.pem ; ( echo 'Content-Type: multipart/signed; protocol=\"application/x-pkcs7-signature\"; micalg=\"sha-256\"; boundary=\"--SIGNED-INSTALLER\"'; echo ; echo ; echo '----SIGNED-INSTALLER' ; cat Dynatrace-OneAgent-Linux-1.307.61.20250226-155505.sh ) | openssl cms -verify -CAfile dt-root.cert.pem > /dev/null\n            /bin/sh Dynatrace-OneAgent-Linux-1.307.61.20250226-155505.sh --set-monitoring-mode=fullstack --set-app-log-content-access=true --set-host-name=Dynatrace-SSM-Action-Demo_{{input()[\"awsaccountid\"]}}\n  \n{% endif %}","Bucket":"dynatraceinstall{{execution().id | replace(\"-\",\"\")}}","region":"{{ input()[\"awsregion\"]}}","connection":"{% set awsconnection = input()[\"create-dynatrace-oidc-connection-settings\"][\"dynatraceawsconnection\"] %}\n{{ connection('builtin:hyperscaler-authentication.connections.aws', awsconnection) }}","ContentType":"Content-Type: text/html; charset=ISO-8859-4"},"retry":{"count":5,"delay":30,"failedLoopIterationsOnly":true},"action":"dynatrace.aws.connector:s3-put-object","active":true,"position":{"x":-1,"y":2},"conditions":{"else":"SKIP","custom":"","states":{"s3-create-bucket-to-store-yaml":"OK"}},"description":"Adds an object to a bucket.","waitBefore":10,"predecessors":["s3-create-bucket-to-store-yaml"]},"create-aws-ebs-remediate-low-storage-remediation-wf":{"name":"create-aws-ebs-remediate-low-storage-remediation-wf","input":{"script":"// optional import of sdk modules\nimport { execution } from '@dynatrace-sdk/automation-utils';\nimport { workflowsClient } from \"@dynatrace-sdk/client-automation\";\nimport { getEnvironmentUrl } from '@dynatrace-sdk/app-environment';\nimport { documentsClient } from \"@dynatrace-sdk/client-document\";\nimport { getEnvironmentId } from '@dynatrace-sdk/app-environment';\nimport { settingsObjectsClient } from \"@dynatrace-sdk/client-classic-environment-v2\";\n\n\nexport default async function ({ executionId , action_execution_id }) {\n  // your code goes here\n  // e.g. get the current execution\n  //const configGet = await fetch(`/platform/automation/v1/executions/${executionId}/tasks/create-service-user/result`);\n  //const configBody = await configGet.json();\n  //const actor = configBody.json.uid   \n  const environmentId = getEnvironmentId();\n  const { input } = await fetch(`/platform/automation/v1/executions/${executionId}`).then((res) => res.json());\n\n  const envurl = getEnvironmentUrl()\n  const data2=\n    await settingsObjectsClient.postSettingsObjects({\n      body: [\n        { \"summary\": \"Low Storage Warning \"+input[\"awsaccountid\"]+\"\", \"searchSummary\": \"Low Storage Warning \"+input[\"awsaccountid\"]+\"\", \"author\": \"Dynatrace support user #179488294\", \"scope\": \"environment\", \"schemaId\": \"builtin:davis.anomaly-detectors\", \"schemaVersion\": \"1.0.10\", \"resourceContext\": { \"operations\": [ \"read\", \"write\", \"delete\" ], \"modifications\": { \"modifiablePaths\": [], \"nonModifiablePaths\": [] } }, \"value\": { \"enabled\": true, \"title\": \"Low Storage Warning \"+input[\"awsaccountid\"]+\"\", \"description\": \"\", \"source\": \"Davis Anomaly Detection\", \"executionSettings\": {}, \"analyzer\": { \"name\": \"dt.statistics.ui.anomaly_detection.StaticThresholdAnomalyDetectionAnalyzer\", \"input\": [ { \"key\": \"query\", \"value\": \"timeseries max(dt.host.disk.used.percent), by: { dt.entity.host }, interval:1m\\n| filter matchesPhrase(entityAttr(dt.entity.host, \\\"entity.name\\\"), \\\"Dynatrace-SSM-Action-Demo_\"+input.awsaccountid+\"\\\")\" }, { \"key\": \"threshold\", \"value\": \"80\" }, { \"key\": \"alertCondition\", \"value\": \"ABOVE\" }, { \"key\": \"alertOnMissingData\", \"value\": \"false\" }, { \"key\": \"violatingSamples\", \"value\": \"2\" }, { \"key\": \"slidingWindow\", \"value\": \"3\" }, { \"key\": \"dealertingSamples\", \"value\": \"3\" } ] }, \"eventTemplate\": { \"properties\": [ { \"key\": \"dt.source_entity\", \"value\": \"{dims:dt.entity.host}\" }, { \"key\": \"event.type\", \"value\": \"RESOURCE_CONTENTION_EVENT\" }, { \"key\": \"event.name\", \"value\": \"Low Storage Warning\" }, { \"key\": \"dt.davis.is_merging_allowed\", \"value\": \"false\" }, { \"key\": \"dt.davis.is_problem_suppressed\", \"value\": \"false\" }, { \"key\": \"dt.davis.is_rootcause_relevant\", \"value\": \"true\" }, { \"key\": \"severity\", \"value\": \"{severity}\" }, { \"key\": \"event.description\", \"value\": \"The Disk Usage by Host {dims:dt.entity.host.name} was above normal behaviour (larger than {threshold}%)\\nDisk usage at time of Alert: {severity}\" }, { \"key\": \"dt.davis.is_frequent_issue_detection_allowed\", \"value\": \"false\" }, { \"key\": \"dt.davis.analysis_trigger_delay\", \"value\": \"60\" }, { \"key\": \"dt.davis.analysis_time_budget\", \"value\": \"120\" } ] } } } ]\n  });\n\n  console.log(data2)\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \n  return {  \"General Davis Anomaly Detection link\": \"\"+getEnvironmentUrl()+\"/ui/apps/dynatrace.davis.anomalydetection/\", \"objectid\": \"\"+data2[0].objectId+\"\"};\n}"},"retry":{"count":5,"delay":30,"failedLoopIterationsOnly":true},"action":"dynatrace.automations:run-javascript","active":true,"position":{"x":1,"y":3},"conditions":{"else":"SKIP","custom":"","states":{"create-aws-ec2-remediate-high-cpu-or-memory-consumption-by-processes-workflow":"OK"}},"description":"Run custom JavaScript code.","predecessors":["create-aws-ec2-remediate-high-cpu-or-memory-consumption-by-processes-workflow"]},"create-aws-ec2-remediate-high-cpu-or-memory-consumption-by-processes-workflow":{"name":"create-aws-ec2-remediate-high-cpu-or-memory-consumption-by-processes-workflow","input":{"script":"// optional import of sdk modules\nimport { execution } from '@dynatrace-sdk/automation-utils';\nimport { workflowsClient } from \"@dynatrace-sdk/client-automation\";\nimport { getEnvironmentUrl } from '@dynatrace-sdk/app-environment';\nimport { documentsClient } from \"@dynatrace-sdk/client-document\";\nimport { getEnvironmentId } from '@dynatrace-sdk/app-environment';\nimport { settingsObjectsClient } from \"@dynatrace-sdk/client-classic-environment-v2\";\n\n\nexport default async function ({ executionId , action_execution_id }) {\n  // your code goes here\n  // e.g. get the current execution\n  //const configGet = await fetch(`/platform/automation/v1/executions/${executionId}/tasks/create-service-user/result`);\n  //const configBody = await configGet.json();\n  const environmentId = getEnvironmentId();\n  const { input } = await fetch(`/platform/automation/v1/executions/${executionId}`).then((res) => res.json());\n \n\n\n  // create anomaly detection\n  const envurl = getEnvironmentUrl()\n  const data2=\n    await settingsObjectsClient.postSettingsObjects({\n      body: [\n        { \"summary\": \"Process Cpu Saturation \"+input[ \"awsaccountid\" ]+\"\", \"searchSummary\": \"Process Cpu Saturation \"+input[ \"awsaccountid\" ]+\"\", \"author\": \"Dynatrace Remediation\", \"scope\": \"environment\", \"schemaId\": \"builtin:davis.anomaly-detectors\", \"schemaVersion\": \"1.0.10\", \"resourceContext\": { \"operations\": [ \"read\", \"write\", \"delete\" ], \"modifications\": { \"modifiablePaths\": [], \"nonModifiablePaths\": [] } }, \"value\": { \"enabled\": true, \"title\": \"Process Cpu Saturation \"+input[ \"awsaccountid\" ]+\"\", \"description\": \"Process Cpu Saturation \"+input[ \"awsaccountid\" ]+\"\", \"source\": \"Davis Anomaly Detection\", \"executionSettings\": { }, \"analyzer\": { \"name\": \"dt.statistics.ui.anomaly_detection.StaticThresholdAnomalyDetectionAnalyzer\", \"input\": [ { \"key\": \"query\", \"value\": \"timeseries max=max(dt.process.cpu.usage), by: { dt.entity.process_group_instance,dt.entity.host },interval:1m\\n| filter matchesPhrase(entityAttr(dt.entity.host, \\\"entity.name\\\"), \\\"Dynatrace-SSM-Action-Demo_\"+input.awsaccountid+\"\\\")\\n| fieldsAdd dt.entity.process_group_instance.name = entityName(dt.entity.process_group_instance)\\n| filter not matchesPhrase(dt.entity.process_group_instance.name,\\\"oneagent\\\")\" }, { \"key\": \"threshold\", \"value\": \"70\" }, { \"key\": \"alertCondition\", \"value\": \"ABOVE\" }, { \"key\": \"alertOnMissingData\", \"value\": \"false\" }, { \"key\": \"violatingSamples\", \"value\": \"2\" }, { \"key\": \"slidingWindow\", \"value\": \"2\" }, { \"key\": \"dealertingSamples\", \"value\": \"2\" } ] }, \"eventTemplate\": { \"properties\": [ { \"key\": \"dt.source_entity\", \"value\": \"{dims:dt.entity.process_group_instance}\" }, { \"key\": \"event.type\", \"value\": \"RESOURCE_CONTENTION_EVENT\" }, { \"key\": \"event.name\", \"value\": \"Process CPU Saturation\" }, { \"key\": \"dt.davis.is_merging_allowed\", \"value\": \"false\" }, { \"key\": \"dt.davis.is_problem_suppressed\", \"value\": \"false\" }, { \"key\": \"dt.davis.is_rootcause_relevant\", \"value\": \"true\" }, { \"key\": \"severity\", \"value\": \"{severity}\" }, { \"key\": \"event.description\", \"value\": \"The CPU Usage by Process {dims:dt.entity.process_group_instance.name} was above normal behaviour (larger than {threshold}%)\" }, { \"key\": \"dt.davis.is_frequent_issue_detection_allowed\", \"value\": \"false\" }, { \"key\": \"dt.davis.timeout\", \"value\": \"7\" }, { \"key\": \"dt.davis.analysis_trigger_delay\", \"value\": \"60\" }, { \"key\": \"dt.davis.analysis_time_budget\", \"value\": \"120\" } ] } } }\n      ]\n    \n    });\n  console.log(data2)\n  \n  return {  \"General Davis Anomaly Detection link\": \"\"+getEnvironmentUrl()+\"/ui/apps/dynatrace.davis.anomalydetection/\", \"objectid\": \"\"+data2[0].objectId+\"\"};\n}"},"retry":{"count":5,"delay":30,"failedLoopIterationsOnly":true},"action":"dynatrace.automations:run-javascript","active":true,"position":{"x":1,"y":2},"conditions":{"else":"SKIP","custom":"","states":{"wait_till_agent_up":"OK"}},"description":"Run custom JavaScript code.","waitBefore":60,"predecessors":["wait_till_agent_up"]}}}